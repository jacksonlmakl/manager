#!/bin/bash

# Get the public IP address of the current host
PUBLIC_IP=$(curl -s ifconfig.me)

# Extract the first ports from the mappings in the docker-compose.yml file, excluding ports starting with 50, 15, or 23
PORTS=$(grep -oP '^\s+- "\K(?!50|15|23)\d+(?=:\d+")' docker-compose.yml)

# Extract container names
CONTAINERS=$(grep -oP 'container_name:\s*\K\S+' docker-compose.yml)

# Function to check if a port is active
check_port() {
    nc -z -w2 "$PUBLIC_IP" "$1" && echo "Active" || echo "Inactive"
}

# Function to check if the container has active processes inside
check_container_activity() {
    # Run 'ps aux' inside the container and count the number of lines
    ACTIVE_PROCESS_COUNT=$(docker exec "$1" ps aux 2>/dev/null | wc -l)

    # If more than one line (i.e., more than just the header), mark as Active
    if [[ "$ACTIVE_PROCESS_COUNT" -gt 1 ]]; then
        echo "Active"
    else
        echo "Inactive"
    fi
}

# Iterate through ports and container names together
index=0
for PORT in $PORTS; do
    CONTAINER=$(echo "$CONTAINERS" | sed -n "$((index+1))p")  # Get corresponding container
    STATUS=$(check_port "$PORT")  # Check port activity
    
    # Check if container exists
    if docker ps --format '{{.Names}}' | grep -q "^$CONTAINER$"; then
        CONTAINER_STATUS=$(check_container_activity "$CONTAINER")
    else
        CONTAINER_STATUS="Not Running"
    fi
    
    echo "http://$PUBLIC_IP:$PORT - $STATUS - Container: $CONTAINER ($CONTAINER_STATUS)"
    ((index++))
done
